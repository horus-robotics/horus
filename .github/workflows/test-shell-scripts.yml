name: Shell Scripts Tests

on:
  push:
    branches: [ main, dev, develop ]
    paths:
      - '**.sh'
      - '.github/workflows/test-shell-scripts.yml'
      - 'tests/shell_scripts/**'
  pull_request:
    branches: [ main, dev, develop ]
    paths:
      - '**.sh'
      - '.github/workflows/test-shell-scripts.yml'
      - 'tests/shell_scripts/**'
  schedule:
    # Run weekly on Monday at 2 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test to run (install, verify, update, uninstall, full-flow, all)'
        required: false
        default: 'all'
      distro:
        description: 'Distribution to test (ubuntu-22.04, ubuntu-24.04, debian-12, fedora-39, all-distros)'
        required: false
        default: 'ubuntu-22.04'

jobs:
  # Quick smoke test on Ubuntu 22.04 (runs on every push)
  smoke-test:
    name: Smoke Test (Ubuntu 22.04)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run install.sh test
        run: |
          cd tests/shell_scripts
          ./run_tests.sh install ubuntu-22.04

      - name: Run verify.sh test
        run: |
          cd tests/shell_scripts
          ./run_tests.sh verify ubuntu-22.04

  # Full test matrix (runs on schedule, manual trigger, or when test files change)
  full-test-matrix:
    name: ${{ matrix.test }} on ${{ matrix.distro }}
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[test-all-distros]')

    strategy:
      fail-fast: false
      matrix:
        distro:
          - ubuntu-22.04
          - ubuntu-24.04
          - debian-12
        test:
          - install
          - verify
          - update
          - uninstall

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run test
        run: |
          cd tests/shell_scripts
          ./run_tests.sh ${{ matrix.test }} ${{ matrix.distro }}

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: test-logs-${{ matrix.test }}-${{ matrix.distro }}
          path: |
            /tmp/horus-test-*.log
          retention-days: 7

  # Full installation flow test
  full-flow-test:
    name: Full Flow on ${{ matrix.distro }}
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[test-all-distros]')

    strategy:
      fail-fast: false
      matrix:
        distro:
          - ubuntu-22.04
          - debian-12

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run full installation flow
        run: |
          cd tests/shell_scripts
          ./run_tests.sh full-flow ${{ matrix.distro }}

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: full-flow-logs-${{ matrix.distro }}
          path: |
            /tmp/horus-test-*.log
          retention-days: 7

  # Manual workflow dispatch
  manual-test:
    name: Manual Test (${{ github.event.inputs.test_type }} on ${{ github.event.inputs.distro }})
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run requested test
        run: |
          cd tests/shell_scripts
          ./run_tests.sh ${{ github.event.inputs.test_type }} ${{ github.event.inputs.distro }}

  # Test summary
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [smoke-test]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "Smoke test status: ${{ needs.smoke-test.result }}"

          if [ "${{ needs.smoke-test.result }}" == "success" ]; then
            echo "All shell script tests passed!"
            exit 0
          else
            echo "Some shell script tests failed"
            exit 1
          fi
